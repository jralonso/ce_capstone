---
- name: Add just created hosts to dynamic in memory inventory
  hosts: localhost
  tasks:
  - name: Add host to group 'just_created' 
    add_host:
      name: '{{ target }}'
      groups: just_created
    become: yes

- name: Create K8s minikube new cluster
  hosts: just_created
  tasks:
  - name: Create deployment
    shell: /usr/local/bin/kubectl create deployment hello-node --image=gcr.io/hello-minikube-zero-install/hello-node 
    register: kubectl
    become: yes

  - debug: var=kubectl.stdout_lines

  - name: Expose deployment
    shell: /usr/local/bin/kubectl expose deployment hello-node --type=LoadBalancer --port=8080
    register: kubectl
    become: yes

  - debug: var=kubectl.stdout_lines

  - name: Get services
    shell: /usr/local/bin/kubectl get services
    register: kubectl
    become: yes

  - debug: var=kubectl.stdout_lines

  - name: Publish service
    shell: /usr/local/bin/minikube service hello-node
    register: minikube 
    become: yes

  - debug: var=kubectl.stdout_lines